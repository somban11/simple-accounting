<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simple Accounting</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Khmer:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb; --primary:#111827; --accent:#111827;
}
body.theme-light{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e5e7eb;--accent:#111827}
body.theme-dark{--bg:#0b1020;--card:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--line:#1e293b;--accent:#22d3ee}
body.theme-blue{--bg:#f6f8ff;--card:#ffffff;--text:#0f172a;--muted:#64748b;--line:#e5e7eb;--accent:#2563eb}
body.theme-gray{--bg:#f5f5f5;--card:#ffffff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;--accent:#374151}
body.theme-red{--bg:#fff7f7;--card:#ffffff;--text:#111827;--muted:#6b7280;--line:#f3d6d6;--accent:#dc2626}
body.theme-green{--bg:#f3fbf6;--card:#ffffff;--text:#0f172a;--muted:#64748b;--line:#d8efe1;--accent:#059669}

*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:"Noto Sans Khmer", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid var(--line);position:sticky;top:0;background:var(--card);z-index:10}
.brand{font-weight:700}
.row{display:flex;align-items:center}.gap{gap:8px}.between{justify-content:space-between}.right{text-align:right}.bold{font-weight:700}
.tabs{display:flex;gap:8px;flex-wrap:wrap;padding:10px 14px}
.tab{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:var(--card);cursor:pointer}
.tab.active{background:var(--accent);color:#fff;border-color:transparent}
.view{display:none;padding:14px}.view.active{display:block}
.card{background:var(--card);border-radius:16px;box-shadow:0 8px 30px rgba(2,6,23,.06);padding:14px;margin-bottom:14px}
.card.light{background:rgba(2,6,23,.03)}
.input{border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fff;width:100%}
.input.sm{width:auto;min-width:120px}
.small{font-size:12px}.muted{color:var(--muted)}
.link{background:none;border:none;color:#2563eb;cursor:pointer;padding:0}
.btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;transition:.2s}
.btn:hover{opacity:.95;transform:translateY(-1px)}
.btn.ghost{background:transparent;color:var(--text);border:1px solid var(--line)}
.btn.danger{color:#dc2626;border:1px solid #dc2626;background:transparent}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-top:1px solid var(--line);text-align:left;vertical-align:top}
.grid.two{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.grid.three{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.grid.four{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.stat{background:rgba(2,6,23,.04);border:1px dashed var(--line);padding:10px;border-radius:12px}
.stat-title{font-size:12px;color:var(--muted)}.stat-val{font-weight:700}
.error{color:#dc2626;font-size:13px}

/* Modal */
.modal.hidden{display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal-card{background:var(--card);color:var(--text);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:16px;max-width:700px;width:100%}

/* Toast */
.toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%) scale(.96);background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:.2s;z-index:60}
.toast.show{opacity:1;transform:translateX(-50%) scale(1)}

.btn.mode-active{background:var(--accent);color:#fff;border-color:transparent}
#mode-hint{margin-left:6px}

input[readonly]{background:rgba(2,6,23,.04); cursor:not-allowed;}

.stat .stat-val{font-size:18px}

.adv-pane{display:none}.adv-pane.active{display:block}

.adv-pane{display:block !important}

#dash-kpi .stat{background:rgba(2,6,23,.04)} #dash-kpi .k{font-size:12px;color:var(--muted)} #dash-kpi .v{font-size:20px;font-weight:700}

/* === Print styles for exporting the Report as PDF === */
@media print {
  /* Hide everything by default */
  body * { visibility: hidden; }
  /* When printing explicitly from our button, show only the report view */
  body.print-report-only #view-report, 
  body.print-report-only #view-report * {
    visibility: visible;
  }
  body.print-report-only #view-report {
    position: absolute;
    left: 0; top: 0;
    width: 100%;
    margin: 0; padding: 0;
  }
  /* Optional: hide buttons/controls marked no-print */
  .no-print { display: none !important; }
}


</style>
</head>
<body>
  <header class="topbar">
    <div class="brand">üíº <span data-i18n="app_name">Simple Accounting</span></div>
    <div class="row gap">
      <select id="themeSelect" class="input sm" title="Theme">
        <option value="light">üå§Ô∏è Light</option>
        <option value="dark">üåô Dark</option>
        <option value="blue">üíô Blue</option>
        <option value="gray">üñ§ Gray</option>
        <option value="red">‚ù§Ô∏è Red</option>
        <option value="green">üíö Green</option>
      </select>
      <select id="langSelect" class="input sm" title="Language">
        <option value="km">·ûÅ·üí·ûò·üÇ·ûö</option>
        <option value="en">English</option>
      </select>
      <button id="btnExport" class="btn ghost" data-i18n="export">Export</button>
      <label for="importFile" class="btn ghost" data-i18n="import">Import</label>
      <input id="importFile" type="file" accept="application/json" style="display:none"/>
      <button id="btnReset" class="btn danger ghost" data-i18n="reset">Reset</button>
    </div>
    <div class="row gap" id="extra-nav" style="display:none"><button class="btn ghost" data-view="report-all">üìä <span data-i18n="report_all">Reports (All)</span></button></div>
</header>

  <nav class="tabs">
    <button class="tab" data-view="dashboard">üìä <span>Dashboard</span></button>
    <button class="tab active" data-view="sales">üßæ <span data-i18n="tab_sales">Sales</span></button>
    <button class="tab" data-view="products">üì¶ <span data-i18n="tab_products">Products</span></button>
    <button class="tab" data-view="customers">üë• <span data-i18n="tab_customers">Customers</span></button>
    <button class="tab" data-view="invoices">üìÑ <span data-i18n="tab_invoices">Invoices</span></button>
    <button class="tab" data-view="report">üìà <span data-i18n="tab_report">Report</span></button>
  </nav>

  <section id="view-sales" class="view active">
    <div class="card">
      <h2>üßæ <span data-i18n="new_invoice">New Invoice</span></h2>
<div class="row gap" style="margin-bottom:8px">
  <span class="small muted">Mode:</span>
  <button id="mode-sale" class="btn ghost">SALE</button>
  <button id="mode-resell" class="btn ghost">RESELL</button>
  <span class="small muted" id="mode-hint">Items auto-use SALE price</span>
</div>
      <div class="grid four">
        <div>
          <label data-i18n="customer">Customer</label>
          <div class="row gap">
            <select id="s-customer" class="input"></select>
            <button id="btnCustomerNew" class="btn ghost" data-i18n="new">New</button>
          </div>
          <div id="s-cust-info" class="small muted"></div>
        </div>
        <div>
          <label data-i18n="seller">Seller</label>
          <input id="s-seller" class="input" placeholder="Name"/>
        </div>
        <div>
          <label data-i18n="branch">Branch</label>
          <input id="s-branch" class="input" placeholder="Main"/>
        </div>
        <div>
          <label data-i18n="invoice_type">Invoice Type</label>
          <select id="s-type" class="input">
            <option value="SALE" data-i18n="sale">SALE</option>
            <option value="RESELL" data-i18n="resell">RESELL</option>
          </select>
        </div>
      </div>

      <div class="card light">
        <div class="row between">
          <b data-i18n="items">Items</b>
          <div class="row gap">
            <input id="barcode" class="input sm" placeholder="Scan/Type barcode" />
            <button id="add-item" class="btn ghost">+ <span data-i18n="add">Add</span></button>
          </div>
        </div>
        <table class="table" id="items">
          <thead>
            <tr>
              <th data-i18n="product">Product</th>
              <th data-i18n="type" style="display:none">Type</th>
              <th data-i18n="qty">Qty</th>
              <th data-i18n="price">Price</th>
              <th data-i18n="cost">Baseline</th>
              <th data-i18n="line_total">Line Total</th>
              <th data-i18n="profit">Profit</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><td colspan="6" class="right"><span data-i18n="subtotal_sale_qty">Subtotal (SALE √ó Qty)</span></td><td id="subAmount" class="right">$ 0.00</td></tr>
            <tr><td colspan="6" class="right"><span data-i18n="profit_subtotal">Profit Subtotal</span></td><td id="subProfit" class="right muted">+ $ 0.00</td></tr>
            <tr>
              <td colspan="4" class="right" data-i18n="discount"><span data-i18n="discount_sale">Discount (SALE)</span></td>
              <td colspan="2">
                <div class="row gap">
                  <select id="disc-type" class="input sm"><option value="amt">$</option><option value="pct">%</option></select>
                  <input id="disc" type="number" step="0.01" value="0" class="input sm"/>
                </div>
              </td>
              <td id="disc-amt" class="right muted">- $ 0.00</td>
            </tr>
            <tr><td colspan="6" class="right bold"><span data-i18n="total_sale_minus_discount">TOTAL (Subtotal ‚àí Discount)</span></td><td id="grand" class="bold right">$ 0.00</td></tr>
          </tfoot>
        </table>
      </div>

      <div class="card light">
        <div class="row between"><b data-i18n="payments">Payments</b><button id="add-payment" class="btn ghost">+ <span data-i18n="add">Add</span></button></div>
        <table class="table" id="payments">
          <thead><tr><th data-i18n="method">Method</th><th data-i18n="amount">Amount</th><th></th></tr></thead>
          <tbody></tbody>
          <tfoot>
            <tr><td class="right" data-i18n="paid">Paid</td><td id="paid"></td><td></td></tr>
            <tr><td class="right" data-i18n="balance">Balance</td><td id="balance" class="bold"></td><td></td></tr>
          </tfoot>
        </table>
        <div class="row gap" style="margin-top:8px">
          <button id="save" class="btn">üíæ <span data-i18n="save_invoice">Save Invoice</span></button>
          <button id="print" class="btn ghost">üñ®Ô∏è <span data-i18n="download_pdf">Download PDF</span></button>
          <span id="s-error" class="error"></span>
        </div>
      </div>
    </div><!-- removed sales summary grid three --><div id="sm-sales" class="stat-val">$ 0.00</div></div>
        <div class="stat"><div class="stat-title">Total Profit</div><div id="sm-profit" class="stat-val">+ $ 0.00</div></div>
        <div class="stat"><div class="stat-title">Invoices</div><div id="sm-count" class="stat-val">0</div></div>
      </div>
      <!-- removed sales-tab By Customer card -->

  <div class="card" id="adv-reports">
    <h2>üìä Reports (Advanced)</h2>
    
    </div>

    <div id="adv-filters" class="row gap" style="margin:8px 0;">
      <div class="row gap">
        <label class="small muted">Date</label>
        <input id="adv-date" class="input sm" type="date">
      </div>
      <div class="row gap">
        <label class="small muted">Month</label>
        <input id="adv-month" class="input sm" type="month">
      </div>
      <div class="row gap">
        <label class="small muted">Type</label>
        <select id="adv-type" class="input sm">
          <option value="ALL">ALL</option>
          <option value="SALE">SALE</option>
          <option value="RESELL">RESELL</option>
        </select>
      </div>
      <button id="adv-run" class="btn">Generate</button>
    </div>

    <div id="adv-panels">
      <div class="card light adv-pane" data-adv="r1">
        <h3>R1 ‚Äî Daily Sales</h3>
        <table class="table" id="tbl-r1"><thead><tr>
          <th>#</th><th>Date/Time</th><th>No.</th><th>Customer</th><th>Type</th><th class="right">Total ($ / ·üõ)</th><th class="right">Profit ($ / ·üõ)</th>
        </tr></thead><tbody></tbody><tfoot></tfoot></table>
      </div>

      <div class="card light adv-pane" data-adv="r2">
        <h3>R2 ‚Äî Monthly Summary</h3>
        <table class="table" id="tbl-r2"><thead><tr>
          <th>Metric</th><th class="right">Amount ($)</th><th class="right">Amount (·üõ)</th>
        </tr></thead><tbody></tbody></table>
      </div>

      <div class="card light adv-pane" data-adv="r3">
        <h3>R3 ‚Äî By Customer</h3>
        <table class="table" id="tbl-r3"><thead><tr>
          <th>Customer</th><th class="right">Total ($)</th><th class="right">Total (·üõ)</th><th class="right">Profit ($)</th><th class="right">Invoices</th>
        </tr></thead><tbody></tbody></table>
      </div>

      <div class="card light adv-pane" data-adv="r4">
        <h3>R4 ‚Äî By Product</h3>
        <table class="table" id="tbl-r4"><thead><tr>
          <th>Product</th><th class="right">Qty Sold</th><th class="right">Sales ($)</th><th class="right">Sales (·üõ)</th><th class="right">Profit ($)</th>
        </tr></thead><tbody></tbody></table>
      </div>

      <div class="card light adv-pane" data-adv="r6">
        <h3>R6 ‚Äî Stock Movement</h3>
        <table class="table" id="tbl-r6"><thead><tr>
          <th>Product</th><th class="right">Stock</th><th class="right">Sold (period)</th><th class="right">Left</th>
        </tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

</section>

<section id="view-dashboard" class="view">
    <div class="card">
      <h2>üìä Dashboard</h2>
      <div class="grid four gap" id="dash-kpi" style="margin-top:10px"></div>
    </div>

    <div class="card light">
      <div class="row between">
        <b>Filters</b>
        <div class="small muted">Set what you want to see ‚Äî then Apply</div>
      </div>
      <div class="grid four">
        <div>
          <label>Date From</label>
          <input id="d-from" type="date" class="input" data-remember />
        </div>
        <div>
          <label>Date To</label>
          <input id="d-to" type="date" class="input" data-remember />
        </div>
        <div>
          <label>Type</label>
          <select id="d-type" class="input" data-remember>
            <option value="ALL">ALL</option>
            <option value="SALE">SALE</option>
            <option value="RESELL">RESELL</option>
          </select>
        </div>
        <div>
          <label>Branch</label>
          <input id="d-branch" class="input" placeholder="Any" data-remember />
        </div>
      </div>
      <div class="grid four" style="margin-top:8px">
        <div>
          <label>Seller</label>
          <input id="d-seller" class="input" placeholder="Name..." data-remember />
        </div>
        <div>
          <label>Customer</label>
          <input id="d-customer" class="input" placeholder="Name/Phone/Location..." data-remember />
        </div>
        <div>
          <label>Product keyword</label>
          <input id="d-product" class="input" placeholder="Find in invoice items..." data-remember />
        </div>
        <div style="align-self:end">
          <button id="d-apply" class="btn">Apply</button>
          <button id="d-clear" class="btn ghost">Clear</button>
        </div>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="row between">
          <b>Recent Invoices</b>
          <span id="d-inv-count" class="small muted">0 found</span>
        </div>
        <table class="table" id="d-invoices">
          <thead><tr>
            <th>#</th><th>Date/Time</th><th>No.</th><th>Customer</th><th>Seller</th><th>Branch</th><th class="right">Total</th><th class="right">Profit</th><th class="right">Status</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <div class="row between">
          <b>Top Products (by sales)</b>
          <span id="d-top-count" class="small muted">0</span>
        </div>
        <table class="table" id="d-top">
          <thead><tr>
            <th>Product</th><th class="right">Qty</th><th class="right">Sales</th><th class="right">Profit</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card light">
      <b>Stock Alerts</b>
      <table class="table" id="d-stock">
        <thead><tr><th>Product</th><th class="right">Qty</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>


  <section id="view-products" class="view">
    <div class="card">
      <div class="row between">
        <h2>üì¶ <span data-i18n="products">Products</span></h2>
        <div class="row gap">
          <input id="p-search" class="input" placeholder="Search..." />
          <button id="p-add" class="btn">+ <span data-i18n="add_product">Add Product</span></button>
        </div>
      </div>
      <table class="table" id="p-table">
        <thead><tr>
          <th data-i18n="product">Product</th>
          <th>Barcode</th>
          <th data-i18n="sale_price">SALE</th>
          <th data-i18n="resell_price">RESELL</th>
          <th data-i18n="cost">Baseline</th>
          <th data-i18n="qty">Qty</th>
          <th data-i18n="status">Status</th>
          <th></th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="view-customers" class="view">
    <div class="card">
      <div class="row between">
        <h2>üë• <span data-i18n="customers">Customers</span></h2>
        <div class="row gap"><input id="c-search" class="input" placeholder="..." /><button id="c-new" class="btn">+ <span data-i18n="new_customer">Customer</span></button></div>
      </div>
      <table class="table" id="c-table"><thead><tr><th data-i18n="name">Name</th><th data-i18n="phone">Phone</th><th data-i18n="location">Location</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="view-invoices" class="view">
    <div class="card">
      <div class="row between">
        <h2>üìÑ <span data-i18n="invoices">Invoices</span></h2>
        <div class="row gap">
          <input id="inv-search" class="input" placeholder="# / customer / seller / branch" />
          <select id="inv-status" class="input sm">
            <option value="ALL">All</option>
            <option value="PAID">PAID</option>
            <option value="UNPAID">UNPAID</option>
          </select>
          <button class="btn ghost invfilter" data-f="ALL">All</button>
          <button class="btn ghost invfilter" data-f="SALE">SALE</button>
          <button class="btn ghost invfilter" data-f="RESELL">RESELL</button>
        </div>
      </div>
      <div class="small">Sort: <button class="link" data-sort="date">Date</button> ¬∑ <button class="link" data-sort="total">Total</button> ¬∑ <button class="link" data-sort="status">Status</button></div>
      <table class="table" id="inv-table"><thead><tr><th>#</th><th data-i18n="date">Date</th><th>No.</th><th data-i18n="seller">·û¢·üí·ûì·ûÄ·ûõ·ûÄ·üã</th><th data-i18n="branch">·ûü·û∂·ûÅ·û∂</th><th data-i18n="status">·ûü·üí·ûê·û∂·ûì·ûó·û∂·ûñ</th><th data-i18n="total">Total</th><th data-i18n="paid">·ûî·û∂·ûì·ûî·ûÑ·üã</th><th data-i18n="balance">·ûì·üÖ·ûü·ûõ·üã</th><th>Action</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  
  <section id="view-report" class="view" style="display:none;">
    <h2>üìä Report</h2>
    <div class="row gap no-print" style="margin:12px 0;">
      <label>Month: <input type="month" id="r-month"></label>
      <label>Type:
        <select id="r-type">
          <option value="ALL">All</option>
          <option value="SALE">Sale</option>
          <option value="RETURN">Return</option>
          <option value="PAID">Paid</option>
          <option value="UNPAID">Unpaid</option>
        </select>
      </label>
      <button id="btn-export-pdf" class="btn">Export to PDF</button>
    </div>
    <canvas id="chart" width="640" height="300" style="max-width:100%;"></canvas>
    <h3>Payment Summary</h3>
    <table class="tbl" id="payments-summary">
      <thead><tr><th>Method</th><th>Amount</th></tr></thead>
      <tbody></tbody>
    </table>
    <h3>Report by Customer</h3>
    <table class="tbl" id="report-by-customer">
      <thead><tr><th>Customer</th><th>Total</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>


  <div id="modal-mask" class="modal hidden">
    <div class="modal-card">
      <h3 id="m-title">Modal</h3>
      <div id="m-body"></div>
      <div class="row gap" style="margin-top:10px">
        <button id="m-save" class="btn" data-i18n="save">Save</button>
        <button id="m-cancel" class="btn ghost" data-i18n="cancel">Cancel</button>
        <span id="m-error" class="error"></span>
      </div>
    </div>
  </div>

  <script>
// Simple Accounting ‚Äî Clean Fixed Edition
const NS = 'sa_clean_v1_';
const K = (k)=> NS+k;
const read = (k,f)=>{ try{return JSON.parse(localStorage.getItem(K(k))||JSON.stringify(f));}catch{return f;} };
const write=(k,v)=>localStorage.setItem(K(k), JSON.stringify(v));
const uid = ()=> Math.random().toString(36).slice(2);
const money = (n)=>'$ '+(Math.round((Number(n)||0)*100)/100).toFixed(2);
const byId = (id)=>document.getElementById(id);
const LOW_STOCK_THRESHOLD = 5;

const valById = (id)=>{ const el = document.getElementById(id); return el? (el.value??'').toString() : ''; };

// Global sale/resell mode
let CURRENT_MODE = 'SALE'; // 'SALE' || 'RESELL'

// Method labels (for Payments & Report)
const METHOD_LABELS = {
  CASH_KHR: 'Cash (KHR)',
  CASH_USD: 'Cash (USD)',
  BANK_ABA_KHR: 'Bank ABA (KHR)',
  BANK_ABA_USD: 'Bank ABA (USD)',
  BANK_ACLEDA_KHR: 'Bank ACLEDA (KHR)',
  BANK_ACLEDA_USD: 'Bank ACLEDA (USD)',
  MOBILE_MONEY: 'Mobile Money',
  OTHER: 'Other'
};

// Initial data
['products','customers','invoices','invSeq','invSeqSale','invSeqResell','theme','lang'].forEach(k=>{ if(read(k,null)===null){ write(k, (k==='invSeq' || k==='invSeqSale' || k==='invSeqResell')?0:(k==='theme'?'light':(k==='lang'?'km':[]))); } });

// i18n
const I18N = {
  km: { app_name:'·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏·ûÇ·ûé·ûì·üÅ·ûô·üí·ûô·ûü·û∂·ûò·ûâ·üí·ûâ', export:'·ûì·û∂·üÜ·ûÖ·üÅ·ûâ', import:'·ûì·û∂·üÜ·ûÖ·ûº·ûõ', reset:'·ûÄ·üÜ·ûé·ûè·üã·û°·ûæ·ûÑ·ûú·û∑·ûâ',
    tab_sales:'·ûõ·ûÄ·üã', tab_products:'·ûë·üÜ·ûì·û∑·ûâ', tab_customers:'·û¢·ûè·û∑·ûê·û∑·ûá·ûì', tab_invoices:'·ûú·û∑·ûÄ·üí·ûÄ·ûô·ûî·ûè·üí·ûö', tab_report:'·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç',
    new_invoice:'·ûú·û∑·ûÄ·üí·ûÄ·ûô·ûî·ûè·üí·ûö‚Äã·ûê·üí·ûò·û∏', customer:'·û¢·ûè·û∑·ûê·û∑·ûá·ûì', new:'·ûê·üí·ûò·û∏', seller:'·û¢·üí·ûì·ûÄ·ûõ·ûÄ·üã', branch:'·ûü·û∂·ûÅ·û∂', invoice_type:'·ûî·üí·ûö·ûó·üÅ·ûë·ûú·û∑·ûÄ·üí·ûÄ·ûô·ûî·ûè·üí·ûö',
    sale:'·ûõ·ûÄ·üã·ûö·û∂·ûô', resell:'·ûõ·ûÄ·üã·ûî·ûì·üí·ûè', items:'·ûí·û∂·ûè·ûª', add:'·ûî·ûì·üí·ûê·üÇ·ûò', product:'·ûë·üÜ·ûì·û∑·ûâ', type:'·ûî·üí·ûö·ûó·üÅ·ûë', qty:'·ûÖ·üÜ·ûì·ûΩ·ûì', price:'·ûè·ûò·üí·ûõ·üÉ', cost:'·ûè·ûò·üí·ûõ·üÉ·ûä·ûæ·ûò',
    line_total:'·ûè·ûò·üí·ûõ·üÉ SALE', profit:'·ûÖ·üÜ·ûé·üÅ·ûâ', discount:'·ûî·ûâ·üí·ûÖ·ûª·üá·ûè·ûò·üí·ûõ·üÉ', payments:'·ûÄ·û∂·ûö·ûî·ûÑ·üã·ûî·üí·ûö·û∂·ûÄ·üã', method:'·ûú·û∑·ûí·û∏', amount:'·ûÖ·üÜ·ûì·ûΩ·ûì',
    paid:'·ûî·û∂·ûì·ûî·ûÑ·üã', balance:'·ûì·üÖ·ûü·ûõ·üã', save_invoice:'·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·ûú·û∑·ûÄ·üí·ûÄ·ûô·ûî·ûè·üí·ûö', download_pdf:'·ûë·û∂·ûâ·ûô·ûÄ PDF',
    products:'·ûë·üÜ·ûì·û∑·ûâ', add_product:'·ûî·ûì·üí·ûê·üÇ·ûò·ûë·üÜ·ûì·û∑·ûâ', sale_price:'·ûè·ûò·üí·ûõ·üÉ SALE', resell_price:'·ûè·ûò·üí·ûõ·üÉ RESELL', status:'·ûü·üí·ûê·û∂·ûì·ûó·û∂·ûñ',
    customers:'·û¢·ûè·û∑·ûê·û∑·ûá·ûì', new_customer:'·û¢·ûè·û∑·ûê·û∑·ûá·ûì', name:'·ûà·üí·ûò·üÑ·üá', phone:'·ûë·ûº·ûö·ûü·üê·ûñ·üí·ûë', location:'·ûë·û∏·ûè·û∂·üÜ·ûÑ',
    invoices:'·ûú·û∑·ûÄ·üí·ûÄ·ûô·ûî·ûè·üí·ûö', date:'·ûê·üí·ûÑ·üÉ·ûÅ·üÇ', report:'·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç', month:'·ûÅ·üÇ', total_sales:'·ûü·ûö·ûª·ûî·ûÄ·û∂·ûö·ûõ·ûÄ·üã', total_profit:'·ûü·ûö·ûª·ûî·ûÖ·üÜ·ûé·üÅ·ûâ',
    save:'·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ', cancel:'·ûî·üÑ·üá·ûî·ûÑ·üã' , subtotal_sale_qty:'·ûü·ûö·ûª·ûî (·ûè·ûò·üí·ûõ·üÉ SALE √ó ·ûÖ·üÜ·ûì·ûΩ·ûì)', profit_subtotal:'·ûÖ·üÜ·ûé·üÅ·ûâ·ûü·ûö·ûª·ûî', discount_sale:'·ûî·ûâ·üí·ûÖ·ûª·üá·ûè·ûò·üí·ûõ·üÉ (·ûõ·ûæ SALE)', total_sale_minus_discount:'·ûü·ûö·ûª·ûî·ûÖ·ûª·ûÑ·ûÄ·üí·ûö·üÑ·ûô (·ûü·ûö·ûª·ûî ‚àí ·ûî·ûâ·üí·ûÖ·ûª·üá·ûè·ûò·üí·ûõ·üÉ)'},
  en: { app_name:'Simple Accounting', export:'Export', import:'Import', reset:'Reset',
    tab_sales:'Sales', tab_products:'Products', tab_customers:'Customers', tab_invoices:'Invoices', tab_report:'Report',
    new_invoice:'New Invoice', customer:'Customer', new:'New', seller:'Seller', branch:'Branch', invoice_type:'Invoice Type',
    sale:'SALE', resell:'RESELL', items:'Items', add:'Add', product:'Product', type:'Type', qty:'Qty', price:'Price', cost:'Cost',
    line_total:'SALE Price', profit:'Profit', discount:'Discount', payments:'Payments', method:'Method', amount:'Amount',
    paid:'Paid', balance:'Balance', save_invoice:'Save Invoice', download_pdf:'Download PDF',
    products:'Products', add_product:'Add Product', sale_price:'SALE', resell_price:'RESELL', status:'Status',
    customers:'Customers', new_customer:'Customer', name:'Name', phone:'Phone', location:'Location',
    invoices:'Invoices', date:'Date', report:'Report', month:'Month', total_sales:'Total Sales', total_profit:'Total Profit',
    save:'Save', cancel:'Cancel' , subtotal_sale_qty:'Subtotal (SALE √ó Qty)', profit_subtotal:'Profit Subtotal', discount_sale:'Discount (on SALE)', total_sale_minus_discount:'TOTAL (Subtotal ‚àí Discount)'}
};
function applyI18n(){
  const lang = read('lang','km');
  document.documentElement.lang = (lang==='km'?'km':'en');
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    const txt = I18N[lang][key] || key;
    el.textContent = txt;
  });
}
const langSelect = byId('langSelect'); langSelect.value = read('lang','km');
langSelect.onchange = ()=>{ write('lang', langSelect.value); applyI18n(); };

// Theme
const themeSelect = byId('themeSelect'); themeSelect.value = read('theme','light');
function applyTheme(){ const t = read('theme','light'); document.body.className = ''; document.body.classList.add('theme-'+t); }
themeSelect.onchange = ()=>{ write('theme', themeSelect.value); applyTheme(); };
applyTheme(); applyI18n();

// Toast
function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.classList.add('show'),10); setTimeout(()=>{t.classList.remove('show'); setTimeout(()=>t.remove(),200);},2000); }

// Mode toggle UI
const modeSaleBtn = document.getElementById('mode-sale');
const modeResellBtn = document.getElementById('mode-resell');
function applyModeUI(){
  if (!modeSaleBtn || !modeResellBtn) return;
  modeSaleBtn.classList.toggle('mode-active', CURRENT_MODE==='SALE');
  modeResellBtn.classList.toggle('mode-active', CURRENT_MODE==='RESELL');
  const hint = document.getElementById('mode-hint');
  if (hint) hint.textContent = CURRENT_MODE==='SALE' ? 'Items auto-use SALE price' : 'Items auto-use RESELL price';
}
if (modeSaleBtn){ modeSaleBtn.onclick = ()=>{ CURRENT_MODE='SALE'; applyModeUI(); try{ recalc && recalc(); }catch(e){} } }
if (modeResellBtn){ modeResellBtn.onclick = ()=>{ CURRENT_MODE='RESELL'; applyModeUI(); try{ recalc && recalc(); }catch(e){} } }


function syncRow(tr){
  const sel = tr.querySelector('.sel-prod'); const opt = sel && sel.selectedOptions ? sel.selectedOptions[0] : null;
  const type = tr.querySelector('.sel-type') ? tr.querySelector('.sel-type').value : (CURRENT_MODE || 'SALE');
  if (!opt){ tr.querySelector('.price').value = '0.00'; tr.querySelector('.cost').value = '0.00'; tr.querySelector('.stock').textContent='Stock: -'; return; }
  const ds = opt.dataset || {};
  const sale = Number(ds.sale || 0);
  const resell = Number(ds.resell || 0);
  const cost = Number(ds.cost || 0);
  const stock = Number(ds.stock || 0);
  tr.querySelector('.price').value = sale.toFixed(2); // editable
  const baseline = Number(tr.querySelector('.cost')?.value || 0);
  tr.querySelector('.cost').value = (baseline||0).toFixed(2); // readonly
  const stockEl = tr.querySelector('.stock'); stockEl.textContent = 'Stock: ' + (isNaN(stock)? '-' : stock); if(!isNaN(stock)) { stockEl.classList.toggle('muted', stock<=LOW_STOCK_THRESHOLD); }
}

function recalc(){
  let subtotal = 0, profitTotal = 0;
  document.querySelectorAll('#items tbody tr').forEach(tr=>{
    const qty = Number(tr.querySelector('.qty')?.value || 0);
    const price = Number(tr.querySelector('.price')?.value || 0);
    const baseline = Number(tr.querySelector('.cost')?.value || 0);
    const line = Math.round(qty*price*100)/100;
    const p = Math.round(qty*(price - baseline)*100)/100;
    tr.querySelector('.line').textContent = money(line);
    tr.querySelector('.linep').textContent = (p>=0?'+ ':'- ')+money(Math.abs(p));
    subtotal = Math.round((subtotal + line)*100)/100;
    profitTotal = Math.round((profitTotal + p)*100)/100;
  });
  let d = Number(byId('disc')?.value || 0);
  if (byId('disc-type') && byId('disc-type').value==='pct'){
    d = Math.round(subtotal*(d/100)*100)/100;
    if (d>subtotal) d=subtotal;
  }
  const total = Math.max(0, Math.round((subtotal - d)*100)/100);
  let paid = 0;
  document.querySelectorAll('.pay-amt').forEach(i=> paid += Number(i.value||0));
  paid = Math.round(paid*100)/100;
  const bal = Math.max(0, Math.round((total - paid)*100)/100);

  byId('disc-amt').textContent = '- '+money(d);
  byId('grand').textContent = money(total);
  byId('paid').textContent = money(paid);
  byId('balance').textContent = money(bal);
  const sp = byId('subProfit'); if (sp) sp.textContent = (profitTotal>=0?'+ ':'- ')+money(Math.abs(profitTotal));
  const sa = byId('subAmount'); if (sa) sa.textContent = money(subtotal);
}
// Tabs
document.querySelectorAll('.tab').forEach(btn=>{
  btn.onclick=()=>{ document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById('view-'+btn.dataset.view).classList.add('active');
    if (btn.dataset.view==='report') { drawReport(); paymentsSummary(getReportMonth()); }
    if (btn.dataset.view==='invoices') renderInvoices();
    if (btn.dataset.view==='products') renderProducts();
    if (btn.dataset.view==='customers') renderCustomers();
    if (btn.dataset.view==='sales') bindSales();
    if (btn.dataset.view==='dashboard') { initDashboard(); }
  };
});

// Export / Import / Reset
byId('btnExport').onclick = ()=>{
  const data = {}; ['products','customers','invoices','invSeq','invSeqSale','invSeqResell','theme','lang'].forEach(k=>data[k]=read(k,null));
  const a = document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'})); a.download='simple_accounting_backup.json'; a.click();
  toast('Exported backup.json');
};
byId('importFile').onchange = async (e)=>{
  const f = e.target.files?.[0]; if (!f) return; const txt = await f.text();
  try{ const d = JSON.parse(txt); for (const k of ['products','customers','invoices','invSeq','theme','lang']){ if (d[k]!==undefined) write(k,d[k]); } toast('Imported'); } catch { toast('Invalid JSON'); }
  e.target.value=''; renderProducts(); renderCustomers(); renderInvoices(); bindSales(); drawReport(); paymentsSummary(getReportMonth()); reportByCustomer(getReportMonth());
};
byId('btnReset').onclick = ()=>{ if(!confirm('Clear all data?')) return; ['products','customers','invoices','invSeq','invSeqSale','invSeqResell','theme','lang'].forEach(k=>localStorage.removeItem(K(k))); location.reload(); };

// Customers
function renderCustomers(){
  const list = read('customers',[]);
  const q = (byId('c-search').value||'').toLowerCase();
  const show = list.filter(c=> (c.name||'').toLowerCase().includes(q) || (c.phone||'').toLowerCase().includes(q) || (c.location||'').toLowerCase().includes(q));
  const tbody = document.querySelector('#c-table tbody');
  tbody.innerHTML = (show.length? show: list).map(c=>'<tr><td>'+ (c.name||'') +'</td><td>'+ (c.phone||'') +'</td><td>'+ (c.location||'') +'</td><td><button class="btn ghost" data-edit="'+c.id+'">Edit</button> <button class="btn ghost" data-del="'+c.id+'">Del</button></td></tr>').join('') || '<tr><td colspan="4">No data</td></tr>';
  tbody.querySelectorAll('[data-edit]').forEach(b=> b.onclick=()=> openCustomerModal(b.dataset.edit));
  tbody.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=> { if(!confirm('Delete customer?')) return; write('customers', read('customers').filter(x=>x.id!==b.dataset.del)); renderCustomers(); bindSales(); });
}
document.getElementById('c-search').oninput = renderCustomers;
document.getElementById('c-new').onclick = ()=> openCustomerModal();
function openCustomerModal(id){
  const m = document.getElementById('modal-mask');
  document.getElementById('m-error').textContent='';
  document.getElementById('m-title').textContent = id? 'Edit Customer' : 'New Customer';
  const c = id? read('customers',[]).find(x=>x.id===id) : {name:'',phone:'',location:''};
  document.getElementById('m-body').innerHTML = '<div class="grid three"><input id="cm-name" class="input" placeholder="Name" value="'+(c?.name||'')+'"/><input id="cm-phone" class="input" placeholder="Phone" value="'+(c?.phone||'')+'"/><input id="cm-location" class="input" placeholder="Location" value="'+(c?.location||'')+'"/></div>';
  m.classList.remove('hidden');
  document.getElementById('m-cancel').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-save').onclick = ()=>{
    const name = valById('cm-name').trim(); if(!name){ document.getElementById('m-error').textContent='Enter name'; return; }
    const phone = valById('cm-phone').trim(); const location = valById('cm-location').trim();
    const list = read('customers',[]);
    if (id){ const i = list.findIndex(x=>x.id===id); if(i>=0) list[i] = {...list[i], name, phone, location}; }
    else { list.push({id:uid(), name, phone, location}); }
    write('customers', list); m.classList.add('hidden'); renderCustomers(); bindSales();
  };
}

// Products
function renderProducts(){
  const list = read('products',[]);
  const q = (byId('p-search').value||'').toLowerCase();
  const show = list.filter(p=> (p.name||'').toLowerCase().includes(q) || (p.barcode||'').toLowerCase().includes(q) );
  const tbody = document.querySelector('#p-table tbody');
  const low = LOW_STOCK_THRESHOLD;
  tbody.innerHTML = (show.length? show:list).map(p=>{
    const lowBadge = (p.qty||0)<=low ? '<span class="small muted">LOW ('+(p.qty||0)+')</span>' : '';
    return '<tr><td>'+p.name+'</td><td>'+(p.barcode||'')+'</td><td>'+money(p.price_sale||0)+'</td><td>'+money(p.price_resell||0)+'</td><td>'+money(p.cost||0)+'</td><td>'+(p.qty||0)+'</td><td>'+lowBadge+'</td><td><button class="btn ghost" data-edit="'+p.id+'">Edit</button> <button class="btn ghost" data-del="'+p.id+'">Del</button></td></tr>';
  }).join('') || '<tr><td colspan="8">No data</td></tr>';
  tbody.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=>{ if(!confirm('Delete product?')) return; write('products', read('products').filter(x=>x.id!==b.dataset.del)); renderProducts(); });
  tbody.querySelectorAll('[data-edit]').forEach(b=> b.onclick=()=> openProductModal(b.dataset.edit));
}
document.getElementById('p-search').oninput = renderProducts;
document.getElementById('p-add').onclick = ()=> openProductModal();
function openProductModal(id){
  const m = document.getElementById('modal-mask'); const p = id? read('products',[]).find(x=>x.id===id) : {name:'', price_sale:0, price_resell:0, cost:0, qty:0, barcode:''};
  document.getElementById('m-error').textContent='';
  document.getElementById('m-title').textContent = id? 'Edit Product' : 'New Product';
  document.getElementById('m-body').innerHTML = '<div class="grid four"><input id="pm-name" class="input" placeholder="Name *" value="'+(p?.name||'')+'"/><input id="pm-barcode" class="input" placeholder="Barcode" value="'+(p?.barcode||'')+'"/><input id="pm-sale" type="number" step="0.01" class="input" placeholder="PRICE *" value="'+(p?.price_sale||0)+'"/><input id="pm-resell" type="number" step="0.01" class="input" placeholder="RESELL *" value="'+(p?.price_resell||0)+'"/></div><div class="grid three" style="margin-top:8px"><input id="pm-cost" type="number" step="0.01" class="input" placeholder="COST *" value="'+(p?.cost||0)+'"/><input id="pm-qty" type="number" step="1" class="input" placeholder="QTY *" value="'+(p?.qty||0)+'"/><div class="small muted" style="align-self:center">Profit = price - cost</div></div>';
  m.classList.remove('hidden');
  document.getElementById('m-cancel').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-save').onclick = ()=>{
    const name = document.getElementById('pm-name').value.trim(); if(!name) { document.getElementById('m-error').textContent='Enter name'; return; }
    const item = {
      id: id || uid(),
      name,
      barcode: document.getElementById('pm-barcode').value.trim(),
      price_sale: Number(document.getElementById('pm-sale').value||0),
      price_resell: Number(document.getElementById('pm-resell').value||0),
      cost: Number(document.getElementById('pm-cost').value||0),
      qty: Math.max(0, Math.floor(Number(document.getElementById('pm-qty').value||0)))
    };
    const list = read('products',[]);
    if (id){ const i = list.findIndex(x=>x.id===id); if(i>=0) list[i] = item; }
    else { list.push(item); }
    write('products', list); m.classList.add('hidden'); renderProducts(); bindSales();
  };
}

// Sales

function bindSales(){
  const thCost = document.querySelector('#items thead th[data-i18n="cost"]');
  if (thCost) thCost.textContent = '·ûè·ûò·üí·ûõ·üÉ·ûõ·ûÄ·üã·ûî·ûì·üí·ûè';
  applyModeUI && applyModeUI();
  const itemsBody = document.querySelector('#items tbody');
  const payBody = document.querySelector('#payments tbody');
  // Ensure containers exist
  if (!itemsBody) return;

  // --- Bind customer select & quick info ---
  const custSel = byId('s-customer');
  const custInfo = byId('s-cust-info');
  const btnCustNew = byId('btnCustomerNew');
  if (btnCustNew) btnCustNew.onclick = ()=> openCustomerModal();

  if (custSel) {
    const customers = read('customers', []);
    custSel.innerHTML = (customers.length
      ? customers.map(c=>`<option value="${c.id}" data-phone="${c.phone||''}" data-location="${c.location||''}">${c.name||'(No name)'}</option>`).join('')
      : ''
    );
    custSel.onchange = ()=>{
      const opt = custSel.selectedOptions && custSel.selectedOptions[0];
      if (custInfo) custInfo.textContent = opt ? (`üìû ${opt.dataset.phone || '-'}  ¬∑  üìç ${opt.dataset.location || '-'}`) : '';
    };
    if (customers.length){ custSel.selectedIndex = 0; custSel.onchange(); }
  }


  // Add item row
  function addItemRow(prodId){
    const tr = document.createElement('tr');
    const prods = read('products',[]);
    const prodOpts = prods.map(p=>{
      const sale = (p.sale ?? p.price_sale ?? p.price ?? 0);
      const resell = (p.resell ?? p.price_resell ?? 0);
      const cost = (p.cost ?? p.price_cost ?? p.cost_price ?? 0);
      const stock = (p.qty ?? p.stock ?? p.quantity ?? 0);
      const name = (p.name ?? p.title ?? '[no name]');
      const id = (p.id ?? p.sku ?? name);
      return `<option value="${id}" data-sale="${sale}" data-resell="${resell}" data-cost="${cost}" data-stock="${stock}">${name}</option>`;
    }).join('');
    tr.innerHTML = `
      <td>
        <select class="input sel-prod"><option value=""></option>${prodOpts}</select>
        <div class="small muted stock">Stock: -</div>
      </td>
      <td style="display:none">
        <select class="input sel-type"><option value="SALE">SALE</option><option value="RESELL">RESELL</option></select>
      </td>
      <td><input class="input qty" type="number" step="1" min="1" value="1"/></td>
      <td><input class="input price" type="number" step="0.01" value="0.00"/></td>
      <td><input class="input cost" type="number" step="0.01" value="0.00"  title="Auto baseline"/></td>
      <td class="line">$ 0.00</td>
      <td class="linep muted">+ $ 0.00</td>
      <td><button class="btn ghost del">Del</button></td>
    `;
    itemsBody.appendChild(tr);

    // Default mode
    const typeSel = tr.querySelector('.sel-type'); typeSel.value = CURRENT_MODE || 'SALE';

    // If prodId provided, select it
    const sel = tr.querySelector('.sel-prod');
    if (prodId) sel.value = prodId;
    // Sync immediately
    syncRow(tr);
    recalc();

    // Wiring
    sel.onchange = ()=>{ syncRow(tr); recalc(); };
    typeSel.onchange = ()=>{ syncRow(tr); recalc(); };
    tr.querySelector('.qty').oninput = ()=>{ const stockTxt = tr.querySelector('.stock')?.textContent||''; const m = stockTxt.match(/(\d+)/); const stock = m? Number(m[1]): NaN; let q = Number(tr.querySelector('.qty').value||0); if(!isNaN(stock) && q>stock){ q = stock; tr.querySelector('.qty').value = q; toast('Not enough stock'); } recalc(); };
    tr.querySelector('.price').oninput = recalc;
    tr.querySelector('.cost').oninput = recalc;
    tr.querySelector('.del').onclick = ()=>{ tr.remove(); recalc(); };
  }

  // Payment row
  function addPaymentRow(){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><select class="input pay-method">
        <option value="cash">$ Cash</option>
        <option value="cash-khr">KHR Cash</option>
        <option value="aba">$ ABA</option>
        <option value="aba-khr">KHR ABA</option>
        <option value="acleda">$ ACLEDA</option>
        <option value="acleda-khr">KHR ACLEDA</option>
      </select></td>
      <td><input class="input pay-amt" type="number" step="0.01" value="0.00"/></td>
      <td></td>`;
    (document.querySelector('#payments tbody')||payBody).appendChild(tr);
    tr.querySelector('.pay-amt').oninput = recalc;
  }

  // Add initial rows if empty
  if (!itemsBody.querySelector('tr')) addItemRow();
  if (!document.querySelector('#payments tbody tr')) addPaymentRow();

  
  // Discount listeners
  if (byId('disc')) byId('disc').oninput = recalc;
  if (byId('disc-type')) byId('disc-type').onchange = recalc;
  recalc();
  // Expose
  window.addItemRow = addItemRow;
  window.addPaymentRow = addPaymentRow;


// --- Update product stock by subtracting sold quantities ---
function updateStock(items){
  if (!Array.isArray(items) || !items.length) return;
  const prods = read('products',[]) || [];
  const map = new Map(prods.map(p=>[(p.id ?? p.sku ?? p.name ?? ''), p]));
  items.forEach(it=>{
    const pid = it.productId || it.id || '';
    const p = map.get(pid);
    if (p){
      const cur = Number(p.qty ?? p.stock ?? 0);
      const next = Math.max(0, Math.round((cur - Number(it.qty||0))*100)/100);
      p.qty = next;
    }
  });
  write('products', prods);
}

// --- Save current sales form as an invoice ---
function buildInvoiceFromForm(){
  // Customer
  const custSel = byId('s-customer');
  const opt = custSel && custSel.selectedOptions ? custSel.selectedOptions[0] : null;
  const customerId = opt ? (opt.value||'') : '';
  const customerName = opt ? (opt.textContent||'').trim() : '';
  // Meta
  const seller = (byId('s-seller')?.value || '').trim();
  const branch = (byId('s-branch')?.value || '').trim();
  const invType = (byId('s-type')?.value || CURRENT_MODE || 'SALE');

  // Items
  const items = [];
  let subtotal = 0, profitTotal = 0;
  document.querySelectorAll('#items tbody tr').forEach(tr=>{
    const prodOpt = tr.querySelector('.sel-prod')?.selectedOptions?.[0];
    const prodId = prodOpt ? prodOpt.value : '';
    const prodName = prodOpt ? prodOpt.textContent : '';
    const qty = Number(tr.querySelector('.qty')?.value || 0);
    const price = Number(tr.querySelector('.price')?.value || 0);
    const baseline = Number(tr.querySelector('.cost')?.value || 0);
    if (prodId && qty>0){
      const amount = Math.round(qty*price*100)/100;
      const profit = Math.round(qty*(price-baseline)*100)/100;
      items.push({productId:prodId, name:prodName, qty, price, baseline, amount, profit});
      subtotal = Math.round((subtotal + amount)*100)/100;
      profitTotal = Math.round((profitTotal + profit)*100)/100;
    }
  });

  // Discount
  let disc = Number(byId('disc')?.value || 0);
  const discType = byId('disc-type')?.value || 'amt';
  if (discType==='pct'){
    disc = Math.round(subtotal*(disc/100)*100)/100;
    if (disc>subtotal) disc=subtotal;
  }
  const total = Math.max(0, Math.round((subtotal - disc)*100)/100);

  // Payments
  const METHOD_MAP = {
    'cash':'CASH_USD',
    'cash-khr':'CASH_KHR',
    'aba':'BANK_ABA_USD',
    'aba-khr':'BANK_ABA_KHR',
    'acleda':'BANK_ACLEDA_USD',
    'acleda-khr':'BANK_ACLEDA_KHR'
  };
  const payments = [];
  let paid = 0;
  document.querySelectorAll('#payments tbody tr').forEach(tr=>{
    const val = (tr.querySelector('.pay-method')?.value || '').toLowerCase();
    const amt = Number(tr.querySelector('.pay-amt')?.value || 0);
    if (amt>0){
      const method = METHOD_MAP[val] || 'OTHER';
      payments.push({method, amount: Math.round(amt*100)/100});
      paid = Math.round((paid + amt)*100)/100;
    }
  });
  const balance = Math.max(0, Math.round((total - paid)*100)/100);
  const status = (paid>=total && total>0) ? 'PAID' : (paid>0 ? 'PARTIAL' : 'UNPAID');

  // Invoice number/sequence
  const seqKey = invType==='RESELL' ? 'invSeqResell' : 'invSeqSale';
  let seq = Number(read(seqKey,0) || 0) + 1;
  write(seqKey, seq);
  const invNo = (invType==='RESELL'?'R-':'S-') + String(seq).padStart(4,'0');

  // Build invoice object
  return {
    id: uid(),
    invNo,
    date: new Date().toISOString().slice(0,10),
    datetime: new Date().toISOString(),
    invType,
    customerId,
    customer: customerName,
    seller,
    branch,
    items,
    subtotal,
    discount: disc,
    total,
    payments,
    paid,
    balance,
    profit: profitTotal,
    status
  };
}

// Attach Save & Print handlers once on Sales bind
if (document.getElementById('save') && !document.getElementById('save')._bound){
  document.getElementById('save').onclick = ()=>{
    const custSel = byId('s-customer');
    if (!custSel || !custSel.value){ byId('s-error').textContent = 'Select customer first'; return; }
    const inv = buildInvoiceFromForm();
    if (!inv.items.length){ byId('s-error').textContent = 'Add at least 1 item'; return; }
    // Validate stock availability
    const prods = read('products',[])||[]; const map = new Map(prods.map(p=>[(p.id ?? p.sku ?? p.name ?? ''), Number(p.qty ?? p.stock ?? 0)]));
    for (const it of inv.items){ const have = map.get(it.productId)||0; if (it.qty>have){ byId('s-error').textContent='Not enough stock for '+(it.name||it.productId); return; } }
    byId('s-error').textContent='';
    const list = read('invoices',[]);
    list.unshift(inv); // add to top
    write('invoices', list);
    updateStock(inv.items);
    toast('Saved: '+inv.invNo);
    renderProducts && renderProducts();
    bindSales && bindSales();
    renderInvoices && renderInvoices();
  };
  document.getElementById('save')._bound = true;
}
if (document.getElementById('print') && !document.getElementById('print')._bound){
  document.getElementById('print').onclick = ()=>{
    const inv = buildInvoiceFromForm();
    // Do not persist; just open print view of the built invoice
    // Temporarily push then print then remove
    const list = read('invoices',[]);
    list.unshift(inv); write('invoices', list);
    try{ printInvoice && printInvoice(inv.id); } finally {
      // remove temp
      const cur = read('invoices',[]).filter(x=>x.id!==inv.id);
      write('invoices', cur);
    }
  };
  document.getElementById('print')._bound = true;
}

}



// Invoices
let INV_FILTER='ALL'; let INV_SORT={by:'date',dir:'desc'};
function renderInvoices(){
  const invs = read('invoices',[]).map(i=> (i.datetime? i : {...i, datetime: (i.date? new Date(i.date+'T00:00:00').toISOString(): new Date().toISOString()) }));
  const q = (byId('inv-search').value||'').toLowerCase();
  const statusSel = byId('inv-status').value;
  let show = invs.filter(i=> INV_FILTER==='ALL'? true : (i.invType||'SALE')===INV_FILTER);
  if (statusSel!=='ALL') show = show.filter(i=> (i.status||((i.balance||0)>0?'UNPAID':'PAID'))===statusSel);
  if (q) show = show.filter(i=>{
    const hay = (i.invNo+' '+(i.customer||'')+' '+(i.customer_phone||'')+' '+(i.seller||'')+' '+(i.branch||'')+' '+(i.notes||'')).toLowerCase();
    return hay.includes(q);
  });
  show.sort((a,b)=>{ const dir = INV_SORT.dir==='asc'?1:-1;
    switch(INV_SORT.by){
      case 'total': return dir*((a.total||0)-(b.total||0));
      case 'status': return dir*((a.status||'').localeCompare(b.status||''));
      default: return dir*(new Date(a.datetime)-new Date(b.datetime));
    }
  });
  const tbody = document.querySelector('#inv-table tbody');
  tbody.innerHTML = show.map((i,idx)=>{
    const bal = Math.max(0, (i.balance!=null? i.balance : ((i.total||0)-(i.paid||0))));
    const status = i.status || (bal>0 ? 'UNPAID' : 'PAID');
    return `<tr>
      <td>${idx+1}</td>
      <td>${new Date(i.datetime).toLocaleString()}</td>
      <td>${i.invNo||''}</td>
      <td>${i.seller||''}</td>
      <td>${i.branch||''}</td>
      <td>${status}</td>
      <td class="right">$ ${(i.total||0).toFixed(2)}</td>
      <td class="right">$ ${(i.paid||0).toFixed(2)}</td>
      <td class="right">$ ${bal.toFixed(2)}</td>
      <td><button class="btn ghost" data-print="${i.id}">Print</button></td>
      <td><button class="btn ghost" data-paid="${i.id}">Mark Paid</button></td>
    </tr>`;
  }).join('') || '<tr><td colspan="11">No data</td></tr>';
  tbody.querySelectorAll('[data-print]').forEach(b=> b.onclick=()=> printInvoice(b.dataset.print));
  tbody.querySelectorAll('[data-paid]').forEach(b=> b.onclick=()=> openMarkPaidModal(b.dataset.paid));
}

document.querySelectorAll('[data-sort]').forEach(b=> b.onclick=()=>{
  const by = b.dataset.sort;
  if (INV_SORT.by===by) INV_SORT = {by, dir:(INV_SORT.dir==='asc'?'desc':'asc')};
  else INV_SORT = {by, dir:'desc'};
  renderInvoices();
});
byId('inv-search').oninput = renderInvoices;
byId('inv-status').onchange = renderInvoices;
document.querySelectorAll('.invfilter').forEach(b=> b.onclick=()=>{ INV_FILTER = b.dataset.f; renderInvoices(); });
function openMarkPaidModal(invId){
  const list = read('invoices',[]);
  const idx = list.findIndex(x=>x.id===invId);
  if (idx<0) return;
  const inv = list[idx];
  const remaining = Math.max(0, Math.round((inv.total - (inv.paid||0))*100)/100);
  const m = document.getElementById('modal-mask');
  document.getElementById('m-title').textContent = 'Mark as Paid';
  document.getElementById('m-error').textContent='';
  document.getElementById('m-body').innerHTML = '<div class="grid two"><div><label>Method</label><select id="mp-method" class="input"><option value="CASH_KHR">Cash (KHR)</option><option value="CASH_USD">Cash (USD)</option><option value="BANK_ABA_KHR">Bank ABA (KHR)</option><option value="BANK_ABA_USD">Bank ABA (USD)</option><option value="BANK_ACLEDA_KHR">Bank ACLEDA (KHR)</option><option value="BANK_ACLEDA_USD">Bank ACLEDA (USD)</option><option value="MOBILE_MONEY">Mobile Money</option><option value="OTHER">Other</option></select></div><div><label>Amount</label><input id="mp-amount" class="input" type="number" step="0.01" value="'+remaining.toFixed(2)+'"/><div class="small muted">Remaining balance: '+remaining.toFixed(2)+'</div></div></div>';
  m.classList.remove('hidden');
  document.getElementById('m-cancel').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-save').onclick = ()=>{
    const method = document.getElementById('mp-method').value;
    let amt = Number(document.getElementById('mp-amount').value||0);
    if (amt<=0){ document.getElementById('m-error').textContent='Amount must be > 0'; return; }
    inv.payments = Array.isArray(inv.payments)? inv.payments : [];
    inv.payments.push({method, amount: amt});
    inv.paid = Math.round(((inv.paid||0) + amt)*100)/100;
    inv.balance = Math.max(0, Math.round((inv.total - inv.paid)*100)/100);
    if (inv.paid >= inv.total){ inv.paid = inv.total; inv.balance = 0; inv.status = 'PAID'; }
    list[idx] = inv; write('invoices', list);
    m.classList.add('hidden'); renderInvoices();
    toast('Marked as PAID: '+inv.invNo);
  };
}

function printInvoice(id){
  const inv = read('invoices',[]).find(x=>x.id===id); if(!inv) return;
  const rows = (inv.items||[]).map((it,idx)=>'<tr><td>'+ (idx+1) +'</td><td>'+ it.name +' ('+ it.rowType +')</td><td class="right">'+ it.qty +'</td><td class="right">'+ money(it.price) +'</td><td class="right">'+ money(it.cost) +'</td><td class="right">'+ money(it.total) +'</td><td class="right">+ '+ money(it.profit) +'</td></tr>').join('');
  const payRows = (inv.payments||[]).map(p=>'<tr><td colspan="5" class="right">'+ (METHOD_LABELS[p.method]||p.method) +'</td><td class="right" colspan="2">'+ money(p.amount) +'</td></tr>').join('') || '<tr><td colspan="7">No payments</td></tr>';
  const css = 'body{font-family:"Noto Sans Khmer", system-ui, Segoe UI, Arial, Roboto, sans-serif;padding:16px} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ccc;padding:6px;text-align:left} .right{text-align:right}';
  const html = '<html><head><meta charset="utf-8"><title>'+ inv.invNo +'</title><style>'+ css +'</style></head><body><h2>Invoice '+ inv.invNo +'</h2><div><b>Date:</b> '+ new Date(inv.datetime).toLocaleString() +'</div><div><b>Customer:</b> '+ inv.customer +' ‚Äî üìû '+ (inv.customerPhone||'-') +' ‚Äî üìç '+ (inv.customerLocation||'-') +'</div><div><b>Seller:</b> '+ (inv.seller||'-') +' ‚Äî <b>Branch:</b> '+ (inv.branch||'-') +'</div><table><thead><tr><th>#</th><th>Item</th><th class="right">Qty</th><th class="right">Price</th><th class="right">Cost</th><th class="right">Total</th><th class="right">Profit</th></tr></thead><tbody>'+ rows +'</tbody><tfoot><tr><td colspan="6" class="right">Subtotal</td><td class="right">'+ money(inv.subtotal) +'</td></tr><tr><td colspan="6" class="right">Discount</td><td class="right">- '+ money(inv.discount||0) +'</td></tr><tr><td colspan="6" class="right"><b>TOTAL</b></td><td class="right"><b>'+ money(inv.total) +'</b></td></tr><tr><td colspan="7"><b>Payments</b></td></tr>'+ payRows +'<tr><td colspan="6" class="right">Paid</td><td class="right">'+ money(inv.paid||0) +'</td></tr><tr><td colspan="6" class="right">Balance</td><td class="right">'+ money(inv.balance||0) +'</td></tr><tr><td colspan="6" class="right">Profit</td><td class="right">+ '+ money(inv.profit||0) +'</td></tr></tfoot></table><script>window.onload=()=>{ try{ window.print(); }catch(e){} };<\/script></body></html>';
  let w = null; try{ w = window.open('','_blank','width=900,height=900'); }catch(e){}
  if (w && w.document){ w.document.write(html); w.document.close(); } else {
    const blob = new Blob([html], {type:'text/html'}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download = inv.invNo + ".html"; a.click();
  }
}

// Report & Payments Summary

function reportByCustomer(monthStr){
  const tb = document.querySelector('#r-bycust tbody'); if (!tb) return;
  const v = (monthStr || new Date().toISOString().slice(0,7));
  const [year, month] = v.split('-').map(Number);
  const typeSel = byId('r-type'); const rType = typeSel? typeSel.value : 'ALL';
  let invs = read('invoices',[]).filter(i=>{ const d = new Date(i.datetime); return (d.getFullYear()===year && (d.getMonth()+1)===month); });
  if (rType!=='ALL') invs = invs.filter(i=> (i.invType||'SALE')===rType);

  // Aggregate by customer
  const agg = {}; // name -> {sales, profit, count}
  invs.forEach(inv=>{
    const name = inv.customer || '(No name)';
    if (!agg[name]) agg[name] = {sales:0, profit:0, count:0};
    agg[name].sales = Math.round((agg[name].sales + (Number(inv.total)||0))*100)/100;
    agg[name].profit = Math.round((agg[name].profit + (Number(inv.profit)||0))*100)/100;
    agg[name].count += 1;
  });

  const names = Object.keys(agg).sort((a,b)=> agg[b].sales - agg[a].sales);
  const rows = names.map(n=>{
    const a = agg[n];
    return `<tr><td>${n}</td><td class="right">$ ${a.sales.toFixed(2)}</td><td class="right">$ ${a.profit.toFixed(2)}</td><td class="right">${a.count}</td></tr>`;
  }).join('') || '<tr><td colspan="4">No data</td></tr>';

  // Totals row
  const totalSales = names.reduce((s,n)=> s + agg[n].sales, 0).toFixed(2);
  const totalProfit = names.reduce((s,n)=> s + agg[n].profit, 0).toFixed(2);
  const totalCount = names.reduce((s,n)=> s + agg[n].count, 0);
  const totalsRow = `<tr><td><b>Total</b></td><td class="right"><b>$ ${totalSales}</b></td><td class="right"><b>$ ${totalProfit}</b></td><td class="right"><b>${totalCount}</b></td></tr>`;

  tb.innerHTML = rows + totalsRow;
}
function drawReport(){
  const typeSel = byId('r-type'); const rType = typeSel? typeSel.value : 'ALL';
  const cvs = document.getElementById('chart'); if(!cvs) return; const ctx = cvs.getContext('2d');
  const v = getReportMonth();
  if (byId('r-month')) byId('r-month').value = v;
  const parts = v.split('-'); const year = Number(parts[0]); const month = Number(parts[1]);
  let invs = read('invoices',[]).filter(i=>{ const d = new Date(i.datetime); return (d.getFullYear()===year && (d.getMonth()+1)===month); });
  if (rType!=='ALL') invs = invs.filter(i=> (i.invType||'SALE')===rType);
  const daysInMonth = new Date(year, month, 0).getDate();
  const sales = new Array(daysInMonth).fill(0);
  invs.forEach(i=>{ const d = new Date(i.datetime).getDate()-1; sales[d] += i.total||0; });
  const sumSales = sales.reduce((a,b)=>a+b,0);
  byId('r-sales').textContent = money(sumSales);
  byId('r-profit').textContent = '+ '+money(invs.reduce((s,i)=>s+(i.profit||0),0));

  ctx.clearRect(0,0,cvs.width,cvs.height);
  const W = cvs.width, H = cvs.height, P=24;
  const max = Math.max(10, ...sales);
  ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(P, H-P); ctx.lineTo(W-P, H-P); ctx.moveTo(P, H-P); ctx.lineTo(P, P); ctx.stroke();
  const barCount = daysInMonth;
  const gap = 2; const barW = ((W - P*2) - gap*(barCount-1)) / barCount;
  ctx.fillStyle = '#2563eb';
  for (let i=0;i<barCount;i++){
    const val = sales[i]; const h = Math.max(1, Math.round((val/max)*(H - P*2)));
    const x = P + i*(barW+gap), y = (H-P) - h;
    ctx.fillRect(x, y, barW, h);
  }
}

function paymentsSummary(monthStr){
  const typeSel = byId('r-type'); const rType = typeSel? typeSel.value : 'ALL';
  const tb = document.querySelector('#r-payments tbody'); if (!tb) return;
  const parts = (monthStr||new Date().toISOString().slice(0,7)).split('-'); const year = Number(parts[0]); const month = Number(parts[1]);
  let invs = read('invoices',[]).filter(i=>{ const d = new Date(i.datetime); return (d.getFullYear()===year && (d.getMonth()+1)===month); });
  if (rType!=='ALL') invs = invs.filter(i=> (i.invType||'SALE')===rType);
  const agg = {};
  invs.forEach(inv=> (inv.payments||[]).forEach(p=>{
    const k = p.method || 'OTHER';
    if (!agg[k]) agg[k] = {total:0, count:0};
    agg[k].total = Math.round((agg[k].total + (Number(p.amount)||0))*100)/100;
    agg[k].count += 1;
  }));
  const order = ['CASH_KHR','CASH_USD','BANK_ABA_KHR','BANK_ABA_USD','BANK_ACLEDA_KHR','BANK_ACLEDA_USD','MOBILE_MONEY','OTHER'];
  const rows = order.filter(k=>agg[k]).map(k=>{
    const label = METHOD_LABELS[k] || k;
    const t = agg[k].total.toFixed(2);
    const c = agg[k].count;
    return '<tr><td>'+label+'</td><td class="right">$ '+t+'</td><td class="right">'+c+'</td></tr>';
  }).join('') || '<tr><td colspan="3">No payments</td></tr>';
  tb.innerHTML = rows;
}

renderProducts(); renderCustomers(); renderInvoices(); bindSales(); drawReport(); paymentsSummary(getReportMonth()); reportByCustomer(getReportMonth());
if(byId('r-month')) byId('r-month').onchange = ()=>{ drawReport(); paymentsSummary(byId('r-month').value); reportByCustomer(byId('r-month').value); };

if(byId('r-type')) byId('r-type').onchange = ()=>{ drawReport(); paymentsSummary(byId('r-month').value); reportByCustomer(byId('r-month').value); };


// === All-in-One Report (AOF) ===
(function(){
  function initAOF(){

  const q = (sel,root=document)=>root.querySelector(sel);
  const qa = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
  const showView = (name)=>{
    qa('.view').forEach(v=>v.classList.remove('active'));
    const view = q('#view-'+name);
    if(view){ view.classList.add('active'); localStorage.setItem('sa_active_view', name); }
  };
  // nav
  qa('[data-view="report-all"]').forEach(btn=>btn.addEventListener('click', ()=>{ location.hash = '#report-all'; }));

  // tabs
  const tabsWrap = q('#report-all-panel');
  if(!tabsWrap) return false;

  qa('.tabs .tab', tabsWrap).forEach(btn=>{
    btn.addEventListener('click', ()=>{
      qa('.tabs .tab', tabsWrap).forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const t = btn.getAttribute('data-tab');
      qa('#aof-tables .tabpane', tabsWrap).forEach(p=>{
        p.classList.toggle('active', p.getAttribute('data-tab')===t);
      });
    });
  });

  // filter mode toggle
  const modeSel = q('#aof-filter-mode');
  const fromEl = q('#aof-date-from'), toEl = q('#aof-date-to'), mEl = q('#aof-month'), yEl=q('#aof-year');
  function reflectMode(){
    if(!modeSel || !fromEl || !toEl || !mEl || !yEl) return;
    const m = modeSel.value || 'range';
    fromEl.style.display = toEl.style.display = (m==='range')?'block':'none';
    mEl.style.display = (m==='month')?'block':'none';
    yEl.style.display = (m==='year')?'block':'none';
  }
  if(modeSel){
    modeSel.addEventListener('change', reflectMode);
  }
  reflectMode();
  // data helpers: read tolerant keys
  const R = (k, fallback=[])=>{
    const candidates = [k, k+'s', k.replace(/s$/,'')];
    for(const c of candidates){
      try{
        const v = JSON.parse(localStorage.getItem('sa_clean_v1_'+c) || 'null');
        if(v) return v;
      }catch{}
    }
    return fallback;
  };

  function parseDate(d){
    if(!d) return null;
    const dt = new Date(d);
    return isNaN(dt) ? null : dt;
  }

  function inRange(dt){
    const mode = modeSel.value;
    if(!dt) return false;
    const D = new Date(dt);
    if(mode==='range'){
      const s = parseDate(fromEl.value); const e = parseDate(toEl.value);
      if(s && D < new Date(s.getFullYear(), s.getMonth(), s.getDate())) return false;
      if(e && D > new Date(e.getFullYear(), e.getMonth(), e.getDate(), 23,59,59)) return false;
      return true;
    }
    if(mode==='month'){
      if(!mEl.value) return true;
      const [y,m] = mEl.value.split('-').map(Number);
      return D.getFullYear()===y && (D.getMonth()+1)===m;
    }
    if(mode==='year'){
      if(!yEl.value) return true;
      const y = Number(yEl.value);
      return D.getFullYear()===y;
    }
    return true;
  }

  function fmt(n){ return '$ '+(Math.round((Number(n)||0)*100)/100).toFixed(2); }

  function sum(arr, key){ return arr.reduce((a,o)=>a+(Number(o[key])||0),0); }

  // build datasets
  function collect(){
    const invoices = (R('invoices', [])).filter(x=>inRange(x.date||x.created_at||x.createdAt));
    const expenses = (R('expenses', [])).filter(x=>inRange(x.date||x.created_at||x.createdAt));
    const purchases = (R('purchases', [])).filter(x=>inRange(x.date||x.created_at||x.createdAt));
    const stock = (R('stock', [])).filter(x=>inRange(x.date||x.created_at||x.createdAt));
    const customers = R('customers', []);
    const suppliers = R('suppliers', []);
    const products = R('products', []);
    return {invoices, expenses, purchases, stock, customers, suppliers, products};
  }

  // render KPI + tables
  function render(){
    const d = collect();
    const totalSale = sum(d.invoices, 'total') || sum(d.invoices, 'grand_total') || sum(d.invoices,'amount');
    const totalProfit = sum(d.invoices, 'profit');
    const tx = d.invoices.length;
    q('#aof-kpi').innerHTML = `
      <div class="stat"><div class="stat-title">Total Sales</div><div class="stat-val">${fmt(totalSale)}</div></div>
      <div class="stat"><div class="stat-title">Total Profit</div><div class="stat-val">${fmt(totalProfit)}</div></div>
      <div class="stat"><div class="stat-title">Invoices</div><div class="stat-val">${tx}</div></div>
      <div class="stat"><div class="stat-title">Expenses</div><div class="stat-val">${fmt(sum(d.expenses,'amount'))}</div></div>
    `;

    drawCharts(d);

    // Render table helper
    function table(el, headers, rows){ if(!el) return;
      el.innerHTML = '<thead><tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr></thead><tbody>'+
        rows.map(r=>'<tr>'+r.map(c=>`<td>${c??''}</td>`).join('')+'</tr>').join('')+'</tbody>';
    }

    // Sales
    table(q('#aof-sales'),
      ['Date','Customer','Seller','Items','Subtotal','Discount','Total','Paid','Balance','Profit'],
      d.invoices.map(v=>[
        (v.date||'').toString().slice(0,10), v.customer||v.customer_name||'', v.seller||'',
        (v.items? v.items.length: (v.lines?v.lines.length:'')),
        fmt(v.subtotal||0), fmt(v.discount||0), fmt(v.total||v.grand_total||0),
        fmt(v.paid||0), fmt((v.total||0)-(v.paid||0)), fmt(v.profit||0)
      ])
    );

    // Purchase
    table(q('#aof-purchase'),
      ['Date','Supplier','Items','Total','Paid','Balance'],
      d.purchases.map(v=>[
        (v.date||'').toString().slice(0,10), v.supplier||v.supplier_name||'',
        (v.items? v.items.length: (v.lines?v.lines.length:'')),
        fmt(v.total||v.grand_total||0),
        fmt(v.paid||0),
        fmt((v.total||0)-(v.paid||0))
      ])
    );

    // Expense
    table(q('#aof-expense'),
      ['Date','Type','Note','Amount'],
      d.expenses.map(v=>[(v.date||'').toString().slice(0,10), v.type||v.category||'', v.note||'', fmt(v.amount||0)])
    );

    // Stock
    table(q('#aof-stock'),
      ['Date','Product','Type','Qty','Balance'],
      d.stock.map(v=>[(v.date||'').toString().slice(0,10), v.product||v.product_name||v.sku||'',
        v.type||v.action||'', v.qty||v.quantity||0, v.balance||'' ])
    );

    // Customer balance
    const balByCust = {};
    d.invoices.forEach(v=>{
      const name = v.customer||v.customer_name||'Unknown';
      const t = Number(v.total||v.grand_total||0), p=Number(v.paid||0);
      balByCust[name] = (balByCust[name]||0) + (t-p);
    });
    if(q('#aof-custbal')) table(q('#aof-custbal'),
      ['Customer','Balance'],
      Object.entries(balByCust).map(([k,v])=>[k, fmt(v)])
    );

    // Supplier balance
    const balBySupp = {};
    d.purchases.forEach(v=>{
      const name = v.supplier||v.supplier_name||'Unknown';
      const t = Number(v.total||v.grand_total||0), p=Number(v.paid||0);
      balBySupp[name] = (balBySupp[name]||0) + (t-p);
    });
    if(q('#aof-suppbal')) table(q('#aof-suppbal'),
      ['Supplier','Balance'],
      Object.entries(balBySupp).map(([k,v])=>[k, fmt(v)])
    );
  }


  // charts
  function drawCharts(d){
    const wrap = q('#aof-charts');
    if(!wrap) return;
    wrap.innerHTML = '';
    // Line: Daily Sales
    const canvas1 = document.createElement('canvas'); canvas1.width=600; canvas1.height=260;
    const c1 = canvas1.getContext('2d');
    // aggregate daily
    const map = {};
    d.invoices.forEach(v=>{
      const key = (v.date||'').toString().slice(0,10);
      map[key] = (map[key]||0) + (Number(v.total||v.grand_total||0));
    });
    const days = Object.keys(map).sort();
    const values = days.map(k=>map[k]);
    // axis
    const W=canvas1.width,H=canvas1.height,P=32;
    c1.clearRect(0,0,W,H);
    c1.beginPath(); c1.moveTo(P, H-P); c1.lineTo(W-P,H-P); c1.lineTo(W-P,P); c1.stroke();
    if(values.length){
      const max = Math.max(...values) || 1;
      const stepX = (W-2*P)/Math.max(1, values.length-1);
      c1.beginPath();
      values.forEach((v,i)=>{
        const x = P + i*stepX;
        const y = (H-P) - (v/max)*(H-2*P);
        if(i===0) c1.moveTo(x,y); else c1.lineTo(x,y);
      });
      c1.stroke();
    }
    const box1 = document.createElement('div'); box1.className='card'; box1.appendChild(canvas1);
    const title1 = document.createElement('div'); title1.textContent='Daily Sales'; title1.style.marginBottom='8px'; box1.prepend(title1);
    wrap.appendChild(box1);

    // Donut: Payment Methods
    const canvas2 = document.createElement('canvas'); canvas2.width=600; canvas2.height=260;
    const c2 = canvas2.getContext('2d');
    const agg = {};
    d.invoices.forEach(inv=> (inv.payments||[]).forEach(p=>{
      const k = p.method || 'OTHER'; agg[k] = (agg[k]||0) + (Number(p.amount)||0);
    }));
    const entries = Object.entries(agg);
    const sumv = entries.reduce((a,kv)=>a+kv[1],0) || 1;
    let start=-Math.PI/2;
    const cx=canvas2.width/2, cy=canvas2.height/2, r=90, ri=55;
    entries.forEach(([k,v])=>{
      const ang = (v/sumv) * Math.PI*2;
      c2.beginPath(); c2.moveTo(cx,cy);
      c2.arc(cx,cy,r,start,start+ang);
      c2.closePath(); c2.fill();
      start += ang;
    });
    // hole
    c2.globalCompositeOperation='destination-out';
    c2.beginPath(); c2.arc(cx,cy,ri,0,Math.PI*2); c2.fill();
    c2.globalCompositeOperation='source-over';
    const box2 = document.createElement('div'); box2.className='card'; box2.appendChild(canvas2);
    const title2 = document.createElement('div'); title2.textContent='Payment Methods'; title2.style.marginBottom='8px'; box2.prepend(title2);
    wrap.appendChild(box2);
  }
  // export & print
  q('#aof-export').addEventListener('click', ()=>{
    const active = q('#aof-tables .tabpane.active table');
    if(!active) return;
    let csv = '';
    active.querySelectorAll('tr').forEach((tr,i)=>{
      const cells = Array.from(tr.children).map(td=>'"'+td.textContent.replace(/"/g,'""')+'"');
      csv += cells.join(',')+'\n';
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'report.csv';
    a.click();
  });

  q('#aof-print').addEventListener('click', ()=>window.print());
  q('#aof-generate').addEventListener('click', render);

  // auto-generate on first open
  render();
  return true;
  }
  // try init now; if section not yet in DOM, wait for DOMContentLoaded
  if(!initAOF()){
    document.addEventListener('DOMContentLoaded', initAOF, {once:true});
  }
})();



// === Currency helpers (E1: fixed rate) ===
const EX_RATE = 4000; // 1 USD = 4000 KHR (fixed)
const moneyKHR = (n)=> '·üõ ' + (Math.round((Number(n)||0)*EX_RATE)).toLocaleString();
const moneyBoth = (usd)=> money(usd) + ' / ' + moneyKHR(usd);

// === Advanced Reports ===
function initAdvancedReports(){
  const tabs = document.querySelectorAll('#adv-tabs .tab');
  const panes = document.querySelectorAll('.adv-pane');
  tabs.forEach(btn=>{
    btn.onclick = ()=>{
      tabs.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const key = btn.getAttribute('data-adv');
      panes.forEach(p=> p.classList.toggle('active', p.getAttribute('data-adv')===key));
    };
  });

  // Defaults: today/month
  const d = new Date();
  const today = d.toISOString().slice(0,10);
  const ym = d.toISOString().slice(0,7);
  const dateEl = byId('adv-date'); if (dateEl && !dateEl.value) dateEl.value = today;
  const monEl = byId('adv-month'); if (monEl && !monEl.value) monEl.value = ym;

  const run = ()=>{
    const dateVal = (byId('adv-date')?.value || today);
    const monthVal = (byId('adv-month')?.value || ym);
    const typeVal = (byId('adv-type')?.value || 'ALL');
    runR1(dateVal, typeVal);
    runR2(monthVal, typeVal);
    runR3(monthVal, typeVal);
    runR4(monthVal, typeVal);
    runR6(monthVal, typeVal);
  };
  byId('adv-run') && (byId('adv-run').onclick = run);
  run(); // auto on open
}

// Data helpers
function getInvoicesByDate(dateStr, type='ALL'){
  const list = read('invoices',[]) || [];
  return list.filter(i=>{
    const d = new Date(i.datetime || (i.date? i.date+'T00:00:00' : new Date().toISOString()));
    const matchDate = (d.toISOString().slice(0,10)===dateStr);
    const matchType = (type==='ALL' ? true : (i.invType||'SALE')===type);
    return matchDate && matchType;
  });
}
function getInvoicesByMonth(ymStr, type='ALL'){
  const list = read('invoices',[]) || [];
  const [y,m] = ymStr.split('-').map(Number);
  return list.filter(i=>{
    const d = new Date(i.datetime || (i.date? i.date+'T00:00:00' : new Date().toISOString()));
    const ok = (d.getFullYear()===y && (d.getMonth()+1)===m);
    const matchType = (type==='ALL' ? true : (i.invType||'SALE')===type);
    return ok && matchType;
  });
}

// R1 Daily
function runR1(dateStr, type='ALL'){
  const invs = getInvoicesByDate(dateStr, type);
  const tb = byId('tbl-r1').querySelector('tbody'); const tf = byId('tbl-r1').querySelector('tfoot');
  let rows = '';
  let sumTotal=0, sumProfit=0;
  invs.forEach((i,idx)=>{
    sumTotal += (Number(i.total)||0);
    sumProfit += (Number(i.profit)||0);
    rows += `<tr>
      <td>${idx+1}</td>
      <td>${new Date(i.datetime).toLocaleString()}</td>
      <td>${i.invNo||''}</td>
      <td>${i.customer||''}</td>
      <td>${i.invType||'SALE'}</td>
      <td class="right">${moneyBoth(i.total||0)}</td>
      <td class="right">${moneyBoth(i.profit||0)}</td>
    </tr>`;
  });
  tb.innerHTML = rows || '<tr><td colspan="7">No data</td></tr>';
  tf.innerHTML = `<tr><td colspan="5" class="right"><b>Total</b></td><td class="right"><b>${moneyBoth(sumTotal)}</b></td><td class="right"><b>${moneyBoth(sumProfit)}</b></td></tr>`;
}

// R2 Monthly
function runR2(ym, type='ALL'){
  const invs = getInvoicesByMonth(ym, type);
  const sum = (k)=> Math.round(invs.reduce((s,v)=> s + (Number(v[k])||0), 0)*100)/100;
  const total = sum('total');
  const profit = sum('profit');
  const paid = sum('paid');
  const balance = Math.max(0, Math.round((total - paid)*100)/100);
  const tb = byId('tbl-r2').querySelector('tbody');
  tb.innerHTML = `
    <tr><td>Total Sales</td><td class="right">${money(total)}</td><td class="right">${moneyKHR(total)}</td></tr>
    <tr><td>Total Profit</td><td class="right">${money(profit)}</td><td class="right">${moneyKHR(profit)}</td></tr>
    <tr><td>Invoices</td><td class="right" colspan="2">${invs.length}</td></tr>
    <tr><td>Paid</td><td class="right">${money(paid)}</td><td class="right">${moneyKHR(paid)}</td></tr>
    <tr><td>Balance</td><td class="right">${money(balance)}</td><td class="right">${moneyKHR(balance)}</td></tr>
  `;
}

// R3 By Customer
function runR3(ym, type='ALL'){
  const invs = getInvoicesByMonth(ym, type);
  const agg = {};
  invs.forEach(i=>{
    const k = i.customer || '(No name)';
    if(!agg[k]) agg[k] = {sales:0, profit:0, count:0};
    agg[k].sales += (Number(i.total)||0);
    agg[k].profit += (Number(i.profit)||0);
    agg[k].count += 1;
  });
  const tb = byId('tbl-r3').querySelector('tbody');
  const keys = Object.keys(agg).sort((a,b)=> agg[b].sales - agg[a].sales);
  tb.innerHTML = keys.map(k=>`
    <tr><td>${k}</td><td class="right">${money(agg[k].sales)}</td><td class="right">${moneyKHR(agg[k].sales)}</td><td class="right">${money(agg[k].profit)}</td><td class="right">${agg[k].count}</td></tr>
  `).join('') || '<tr><td colspan="5">No data</td></tr>';
}

// R4 By Product
function runR4(ym, type='ALL'){
  const invs = getInvoicesByMonth(ym, type);
  const prod = {}; // name -> {qty, sales, profit}
  invs.forEach(i=> (i.items||[]).forEach(it=>{
    const name = it.name || '(item)';
    if(!prod[name]) prod[name] = {qty:0, sales:0, profit:0};
    prod[name].qty += (Number(it.qty)||0);
    prod[name].sales += (Number(it.amount || it.total || 0));
    prod[name].profit += (Number(it.profit)||0);
  }));
  const tb = byId('tbl-r4').querySelector('tbody');
  const keys = Object.keys(prod).sort((a,b)=> prod[b].sales - prod[a].sales);
  tb.innerHTML = keys.map(k=>`
    <tr><td>${k}</td><td class="right">${prod[k].qty}</td><td class="right">${money(prod[k].sales)}</td><td class="right">${moneyKHR(prod[k].sales)}</td><td class="right">${money(prod[k].profit)}</td></tr>
  `).join('') || '<tr><td colspan="5">No data</td></tr>';
}

// R6 Stock Movement (approximate OUT from invoices, stock from products)
function runR6(ym, type='ALL'){
  const prods = read('products',[]) || [];
  const invs = getInvoicesByMonth(ym, type);
  const sold = {}; // product name -> qty sold
  invs.forEach(i=> (i.items||[]).forEach(it=>{
    const name = it.name || '(item)';
    sold[name] = (sold[name]||0) + (Number(it.qty)||0);
  }));
  const stockMap = new Map(prods.map(p=> [p.name, Number(p.qty||p.stock||0)]));
  const names = Array.from(new Set([...stockMap.keys(), ...Object.keys(sold)]));
  const tb = byId('tbl-r6').querySelector('tbody');
  tb.innerHTML = names.map(n=>{
    const stock = stockMap.has(n) ? stockMap.get(n) : 0;
    const s = sold[n] || 0;
    const left = Math.max(0, Number(stock) - Number(s));
    return `<tr><td>${n}</td><td class="right">${stock}</td><td class="right">${s}</td><td class="right">${left}</td></tr>`;
  }).join('') || '<tr><td colspan="4">No data</td></tr>';
}





// === Dashboard (Style A: Simple Box + Filters) ===
function initDashboard(){
  // Default date range = this month
  const now = new Date();
  const ym = now.toISOString().slice(0,7);
  const first = ym + "-01";
  const lastDay = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
  const last = ym + "-" + String(lastDay).padStart(2,'0');

  const setIfEmpty = (id,val)=>{ const el = byId(id); if (el && !el.value) el.value = val; };
  setIfEmpty('d-from', first);
  setIfEmpty('d-to', last);

  const apply = ()=>{
    const opts = {
      from: byId('d-from')?.value || first,
      to: byId('d-to')?.value || last,
      type: byId('d-type')?.value || 'ALL',
      branch: (byId('d-branch')?.value || '').toLowerCase().trim(),
      seller: (byId('d-seller')?.value || '').toLowerCase().trim(),
      customer: (byId('d-customer')?.value || '').toLowerCase().trim(),
      product: (byId('d-product')?.value || '').toLowerCase().trim(),
    };
    renderDashboard(opts);
  };
  byId('d-apply') && (byId('d-apply').onclick = apply);
  byId('d-clear') && (byId('d-clear').onclick = ()=>{
    ['d-branch','d-seller','d-customer','d-product'].forEach(id=>{ const el=byId(id); if(el){ el.value=''; el.dispatchEvent(new Event('input')); }});
    apply();
  });

  apply();
}

function filterInvoicesRange(opts){
  const invs = (read('invoices',[]) || []).map(i=> (i.datetime? i : {...i, datetime: (i.date? i.date+'T00:00:00' : new Date().toISOString()) }));
  const from = new Date(opts.from+'T00:00:00').getTime();
  const to = new Date(opts.to+'T23:59:59').getTime();
  const type = (opts.type||'ALL');
  return invs.filter(i=>{
    const t = new Date(i.datetime).getTime();
    if (t < from || t > to) return false;
    if (type!=='ALL' && (i.invType||'SALE')!==type) return false;
    if (opts.branch && (i.branch||'').toLowerCase().indexOf(opts.branch)===-1) return false;
    if (opts.seller && (i.seller||'').toLowerCase().indexOf(opts.seller)===-1) return false;
    if (opts.customer){
      const hay = ((i.customer||'')+' '+(i.customer_phone||'')+' '+(i.customerLocation||'') ).toLowerCase();
      if (hay.indexOf(opts.customer)===-1) return false;
    }
    if (opts.product){
      const items = i.items||[];
      const ok = items.some(it => ((it.name||'')+' '+(it.productId||'')).toLowerCase().indexOf(opts.product)!==-1);
      if (!ok) return false;
    }
    return true;
  });
}

function renderDashboard(opts){
  const invs = filterInvoicesRange(opts);
  // KPIs
  const sum = (k)=> Math.round(invs.reduce((s,i)=> s + (Number(i[k])||0), 0)*100)/100;
  const total = sum('total');
  const profit = sum('profit');
  const paid = sum('paid');
  const balance = Math.max(0, Math.round((total - paid)*100)/100);
  const kpi = byId('dash-kpi');
  if (kpi){
    kpi.innerHTML = [
      ['Total Sales', money(total)],
      ['Total Profit', '+ '+money(profit)],
      ['Invoices', String(invs.length)],
      ['Balance (Unpaid)', money(balance)]
    ].map(([k,v])=> `<div class="stat"><div class="k">${k}</div><div class="v">${v}</div></div>`).join('');
  }

  // Recent invoices (sorted desc by datetime)
  const tbody = byId('d-invoices')?.querySelector('tbody');
  const sorted = [...invs].sort((a,b)=> new Date(b.datetime)-new Date(a.datetime));
  if (tbody){
    tbody.innerHTML = (sorted.slice(0,100).map((i,idx)=>{
      const bal = Math.max(0, (i.balance!=null? i.balance : ((i.total||0)-(i.paid||0))));
      const status = i.status || (bal>0 ? 'UNPAID' : 'PAID');
      return `<tr>
        <td>${idx+1}</td>
        <td>${new Date(i.datetime).toLocaleString()}</td>
        <td>${i.invNo||''}</td>
        <td>${i.customer||''}</td>
        <td>${i.seller||''}</td>
        <td>${i.branch||''}</td>
        <td class="right">${money(i.total||0)}</td>
        <td class="right">${money(i.profit||0)}</td>
        <td class="right">${status}</td>
      </tr>`;
    }).join('')) || '<tr><td colspan="9">No invoices</td></tr>';
  }
  const invCount = byId('d-inv-count'); if (invCount) invCount.textContent = sorted.length + ' found';

  // Top products (aggregate from items)
  const prod = {};
  sorted.forEach(i=> (i.items||[]).forEach(it=>{
    const name = it.name || '(item)';
    if (!prod[name]) prod[name] = {qty:0, sales:0, profit:0};
    prod[name].qty += Number(it.qty)||0;
    prod[name].sales += Number(it.amount || it.total || 0);
    prod[name].profit += Number(it.profit || 0);
  }));
  const topBody = byId('d-top')?.querySelector('tbody');
  if (topBody){
    const keys = Object.keys(prod).sort((a,b)=> prod[b].sales - prod[a].sales);
    topBody.innerHTML = (keys.slice(0,50).map(n=>{
      const x = prod[n];
      return `<tr><td>${n}</td><td class="right">${x.qty}</td><td class="right">${money(x.sales)}</td><td class="right">${money(x.profit)}</td></tr>`;
    }).join('')) || '<tr><td colspan="4">No data</td></tr>';
  }
  const topCount = byId('d-top-count'); if (topCount) topCount.textContent = Object.keys(prod).length;

  // Stock alerts (LOW_STOCK_THRESHOLD from script.js)
  const prods = read('products',[]) || [];
  const low = (typeof LOW_STOCK_THRESHOLD!=='undefined') ? LOW_STOCK_THRESHOLD : 5;
  const lows = prods.filter(p=> (Number(p.qty||p.stock||0) <= low));
  const stBody = byId('d-stock')?.querySelector('tbody');
  if (stBody){
    stBody.innerHTML = (lows.map(p=> `<tr><td>${p.name||'(no name)'}</td><td class="right">${Number(p.qty||p.stock||0)}</td></tr>`).join('')) || '<tr><td colspan="2">No low stock</td></tr>';
  }
}

// Hook: open dashboard tab
(function(){
  const tabBtn = Array.from(document.querySelectorAll('.tab')).find(b=> b.dataset.view==='dashboard');
  if (tabBtn && !tabBtn._dashBound){
    tabBtn._dashBound = true;
    // also ensure country i18n unchanged; dashboard uses English labels intentionally simple
  }
})();

// === Export to PDF (via Print) ===
(function attachExportPdf() {
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    var btn = document.getElementById('btn-export-pdf');
    if(!btn) return;
    btn.addEventListener('click', function(){
      // Add a class to limit print area to the report view
      document.body.classList.add('print-report-only');
      setTimeout(function(){
        window.print();
        // Remove the class after print
        document.body.classList.remove('print-report-only');
      }, 50);
    });
  });
})();


</script>

  <section id="view-report-all" class="view">
    <div class="card">
      <h2>üìä <span data-i18n="report_all">Reports (All-in-One)</span></h2>
      <div class="grid three gap">
        <div>
          <label>Filter Mode</label>
          <select id="aof-filter-mode" class="input">
            <option value="range">Date Range</option>
            <option value="month">Month</option>
            <option value="year">Year</option>
          </select>
        </div>
        <div>
          <label>Date From ‚Üí To / Month / Year</label>
          <div class="row gap">
            <input id="aof-date-from" type="date" class="input">
            <input id="aof-date-to" type="date" class="input">
            <input id="aof-month" type="month" class="input" style="display:none">
            <input id="aof-year" type="number" min="2000" max="2100" class="input" placeholder="2025" style="display:none">
          </div>
        </div>
        <div>
          <label>Style</label>
          <select id="aof-style" class="input">
            <option value="simple">A) Simple Table</option>
            <option value="summary">B) Table + Summary</option>
            <option value="group">C) Grouped (Customer/Seller/Product)</option>
          </select>
        </div>
      </div>

      <div class="row gap mt">
        <button class="btn" id="aof-generate">Generate</button>
        <button class="btn ghost" id="aof-export">Export CSV</button>
        <button class="btn ghost" id="aof-print">Print / PDF</button>
      </div>

      <div class="kpi grid four mt" id="aof-kpi"></div>
      <div id="aof-charts" class="grid two gap mt"></div>

      <div class="tabs mt" id="aof-tabs">
        <button class="tab active" data-tab="sales">Sales</button>
        <button class="tab" data-tab="purchase">Purchase</button>
        <button class="tab" data-tab="expense">Expense</button>
        <button class="tab" data-tab="stock">Stock</button>
      </div>

      <div id="aof-tables" class="mt">
        <div class="tabpane active" data-tab="sales"><table class="table" id="aof-sales"></table></div>
        <div class="tabpane" data-tab="purchase"><table class="table" id="aof-purchase"></table></div>
        <div class="tabpane" data-tab="expense"><table class="table" id="aof-expense"></table></div>
        <div class="tabpane" data-tab="stock"><table class="table" id="aof-stock"></table></div>
      </div>
    </div>
  </section>

</body>
</html>
